import boto3  
import collections  
import datetime  
import csv  
from time import gmtime, strftime  
import smtplib  
from email.MIMEMultipart import MIMEMultipart  
from email.MIMEBase import MIMEBase  
from email.MIMEText import MIMEText  
from email import Encoders  
import os
client = boto3.client('ec2')
def lambda_handler(event, context):
    #get to the curren date
    date_fmt = strftime("%Y_%m_%d", gmtime())
    #Give your file path
    filepath ='/tmp/Volume_Status' + date_fmt + '.csv'
    #Give your filename
    filename ='Volume_Status' + date_fmt + '.csv'
    csv_file = open(filepath,'w+')
    response = client.describe_volume_status(
        Filters=[
            {
                'Name': 'volume-status.status',
                'Values': [
                    'ok','impaired','warning','insufficeient-data'
                ]
            },
        ]
	
    )
    for i in response["VolumeStatuses"]:
        if i["VolumeStatus"]["Status"] == "ok":
            VolumeId = (i["VolumeId"])
            AZ =(i["AvailabilityZone"])
            Events= (i["Events"] )
            Actions = (i["Actions"] )
            Volume_Status = (i["VolumeStatus"]["Status"])
            csv_file.write("%s,%s,%s \n"%('','',''))
            csv_file.write("%s,%s,%s \n"%('VolumeId','AZ','Volume_Status'))
            csv_file.flush()
            csv_file.write("%s,%s,%s \n" % (VolumeId,AZ,Volume_Status))
            csv_file.flush()
        print (Volume_Status)
        print (VolumeId)
        print (AZ)
    #Give ses_user and ses_pwd    
    ses_user = "************"
    ses_pwd = "**************"
    def mail(fromadd,to, subject, body, attach):
       msg = MIMEMultipart()
       msg['From'] = fromadd
       msg['To'] = to
       msg['Subject'] = subject
       msg.attach(MIMEText(body))
       part = MIMEBase('application', 'octet-stream')
       part.set_payload(open(attach, 'rb').read())
       Encoders.encode_base64(part)
       part.add_header('Content-Disposition','attachment; filename="%s"' % os.path.basename(attach))
       msg.attach(part)
       mailServer = smtplib.SMTP("email-smtp.us-west-2.amazonaws.com", 587)
       mailServer.ehlo()
       mailServer.starttls()
       mailServer.ehlo()
       mailServer.login(ses_user, ses_pwd)
       mailServer.sendmail(fromadd, to, msg.as_string())
       mailServer.close()
    #Give From address and To address   
    mail("From Address","To Address","Volume_Status","Hello, \n\nPFA.., \n\nHere in the attachement find out the EBS Volumes having Status is " + Volume_Status +"\n\nThanks,\nMinfy Team.", filepath)
